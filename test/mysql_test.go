package test

import (
	"bnb-48-ins-indexer/dao"
	"bnb-48-ins-indexer/pkg/helper"
	"bnb-48-ins-indexer/pkg/types"
	"bnb-48-ins-indexer/pkg/utils"
	"encoding/json"
	"fmt"
	"os"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"
	"gorm.io/driver/mysql"
	"gorm.io/gorm"
)

var db *gorm.DB

func init() {
	_db, err := gorm.Open(mysql.Open(fmt.Sprintf("root:%s@tcp(127.0.0.1:3306)/bnb48_inscription", os.Getenv("MYSQL_ROOT_PASSWORD"))))
	if err != nil {
		panic(err)
	}
	db = _db
}

func TestLoadChanges(t *testing.T) {
	accountRecordsModel := []*dao.AccountRecordsModel{}
	db = db.Table((&dao.AccountRecordsHandler{}).TableName()).Where("delete_at = 0").Limit(1).Find(&accountRecordsModel)
	for k, v := range accountRecordsModel {
		_ = json.Unmarshal([]byte(v.OpJson), &accountRecordsModel[k].InputDecode)
	}
	b, _ := json.MarshalIndent(accountRecordsModel[0].InputDecode, "", "\t")
	t.Log(string(b))
}

func TestIfInWhere(t *testing.T) {
	/*
		need sql like this:
		SELECT * FROM `account_records` WHERE block >=35033698 AND IF(`block` = 35033698, tx_index >=54 AND op_index >= 0, true) ORDER BY `block` desc, `tx_index` desc LIMIT 240,30;

		note: run this test, you need to start mysql service and set env MYSQL_ROOT_PASSWORD to your mysql root password
	*/
	req := types.ListRecordReq{
		BlockNumber: 35033698,
		TxIndex:     54,
		OpIndex:     0,
		CommonListCond: types.CommonListCond{
			Page:     8,
			PageSize: 30,
		},
	}

	sqlStr := db.ToSQL(func(tx *gorm.DB) *gorm.DB {
		tx = tx.Order("`block` desc, `tx_index` desc")
		if req.TickHash != "" {
			tx = tx.Where("`tick_hash` = ?", req.TickHash)
		}
		if req.BlockNumber != 0 {
			// 根据区块号查询
			tx = tx.Where("`block` >= ?", req.BlockNumber).Where("IF(`block` = ?, tx_index >=? AND op_index >= ?, true)", req.BlockNumber, req.TxIndex, req.OpIndex)
		}
		if req.PageSize > 0 {
			tx = tx.Limit(int(req.PageSize))
		}
		tx = tx.Offset(int(req.Page) * int(req.PageSize))
		tx.Table("account_records").Where("delete_at = 0").Find(&[]dao.AccountRecordsModel{})
		return tx
	})
	wantSQL := "SELECT * FROM `account_records` WHERE `block` >= 35033698 AND (IF(`block` = 35033698, tx_index >=54 AND op_index >= 0, true)) AND delete_at = 0 ORDER BY `block` desc, `tx_index` desc LIMIT 30 OFFSET 240"
	assert.Equal(t, wantSQL, sqlStr)
}

func TestNewStructToJson(t *testing.T) {
	txHash := "0xba6e736afc6587c05d93fe22ddc6a53e380698ad233b05974881c961eb9bb938"
	txFrom := strings.ToLower("0xaACc290a1A4c89F5D7bc29913122F5982916de48")
	bn := uint64(34_862_697)
	arh := &dao.AccountRecordsHandler{}

	assert.NoError(t, db.Exec("TRUNCATE `account_records`").Error)

	fileBytes, _ := os.ReadFile(txHash)
	ins, err := utils.InputToBNB48Inscription(string(fileBytes), bn)
	assert.NoError(t, err)
	for k, v := range ins {
		record := &dao.AccountRecordsModel{
			Block:    bn,
			TxHash:   txHash,
			TxIndex:  uint64(119),
			OpIndex:  uint64(k),
			TickHash: v.TickHash,
			BlockAt:  bn,
			From:     txFrom,
			To:       txFrom,
			Input:    string(fileBytes),
			Type:     helper.InscriptionStatusTransfer,
			OpJson: func() string {
				b, _ := json.Marshal(v)
				return string(b)
			}(),
		}
		assert.NoError(t, arh.Create(db, record))
	}

	// find address 0xda4ee24723ccf8f7ad840ce4647049f91ff664fe
	findAddress := "0xda4ee24723ccf8f7ad840ce4647049f91ff664fe"
	tx := db.Table(arh.TableName()).Where("delete_at = 0").Where("(`from` = ? OR `op_json_to` = ? AND `op_json_op` = ?) OR (`op_json_to` = ? OR op_json_from = ? AND `op_json_op` = ?)", findAddress, findAddress, "transfer", findAddress, findAddress, "transferFrom").Order("block desc, tx_index desc, op_index desc")
	accountRecordsModel := dao.AccountRecordsModel{}

	sqlStr := tx.Session(&gorm.Session{Context: tx.Statement.Context}).ToSQL(func(sql *gorm.DB) *gorm.DB {
		return sql.Find(&accountRecordsModel)
	})
	t.Log(sqlStr)

	assert.NoError(t, tx.Find(&accountRecordsModel).Error)
	assert.NoError(t, json.Unmarshal([]byte(accountRecordsModel.OpJson), &accountRecordsModel.InputDecode))

	b, _ := json.MarshalIndent(accountRecordsModel, "", "\t")
	t.Log(string(b))
	/*
			=== RUN   TestNewStructToJson
		    /Users/nyoku/Documents/GitHub/bnb-48-ins-indexer/test/mysql_test.go:104: SELECT * FROM `account_records` WHERE delete_at = 0 AND ((`from` = '0xda4ee24723ccf8f7ad840ce4647049f91ff664fe' OR `op_json_to` = '0xda4ee24723ccf8f7ad840ce4647049f91ff664fe' AND `op_json_op` = 'transfer') OR (`op_json_to` = '0xda4ee24723ccf8f7ad840ce4647049f91ff664fe' OR op_json_from = '0xda4ee24723ccf8f7ad840ce4647049f91ff664fe' AND `op_json_op` = 'transferFrom')) ORDER BY block desc, tx_index desc, op_index desc
		    /Users/nyoku/Documents/GitHub/bnb-48-ins-indexer/test/mysql_test.go:110: {
		                "id": "495987852883001444",
		                "block": 34862697,
		                "block_at": 34862697,
		                "is_pending": false,
		                "tx_hash": "0xba6e736afc6587c05d93fe22ddc6a53e380698ad233b05974881c961eb9bb938",
		                "op_index": 1,
		                "tx_index": 119,
		                "tick_hash": "0xd893ca77b3122cb6c480da7f8a12cb82e19542076f5895f21446258dc473a7c2",
		                "from": "0xaacc290a1a4c89f5d7bc29913122f5982916de48",
		                "to": "0xaacc290a1a4c89f5d7bc29913122f5982916de48",
		                "input_decode": {
		                        "p": "bnb-48",
		                        "op": "transfer",
		                        "tick": "",
		                        "tick-hash": "0xd893ca77b3122cb6c480da7f8a12cb82e19542076f5895f21446258dc473a7c2",
		                        "to": "0xda4ee24723ccf8f7ad840ce4647049f91ff664fe",
		                        "decimals": "",
		                        "max": "",
		                        "lim": "",
		                        "miners": null,
		                        "amt": "1000000000",
		                        "spender": "",
		                        "from": ""
		                },
		                "input": "0x646174613a2c5b7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307862323635613462323133366632633533343363626538646365373464626463643837383661653165222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307864613465653234373233636366386637616438343063653436343730343966393166663636346665222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a223078316661356261396366613738363
		13837346364303064613139326235313038343162366464356535222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307832313634643131383332396230333637373731303132376437383738613537646232623165646335222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307832326531323532626236306564373434356434306365386139353934353063653232373430353661222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646
		334373361376332222c22746f223a22307832373436333761363239623538353132313464623730336236393633653937636432633962623061222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307833363562313837343634633065656435626639373966373965313763336363363964353037646437222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307833383532376665356463356165323635626331343839363765373131353336326365363230383865222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a223078643839336361373762333132326362366334383064613766386
		13132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307833636235656430313765383834613630623466623063653864343934353034633961326438303239222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307834626337383461313235656337313761383335643763663333643364663166643333393736353863222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307835323235313932333535373331346163373439656235643137326565663436356139656463646565222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d6861736
		8223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307835366261626439613765633461633565633337383065656636373438323231303163353666623361222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307835663265613666396438356465623065643865303562653736313665336464666264323435373138222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307836323838373932303535633661623939346133353965333631303930393761363633653231373366222c22616d74223a2231303030303030303030227d2c7b2270223a22626e6
		22d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307836353035336266656366663565346232663938653232313433373666376337336630653334326262222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307837303635383062343137366165326131653738393030393132303466643231616363633266393039222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a2230783732613533666233303964623831383438393565303239313734653234373936653062386537643
		0222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307837333236663061306336626361623038623362623061623037656364313938303036613331313233222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307837333836306463383035356133363139396661303137653464396236353834653134393764663835222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307837343432393035636
		165656362613731623232323238376632346466356463663661343637306335222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307837663533373237333565356635333338353832643166333261353836653462343233616436393939222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307838316361363936396131613638343039636462313031353231366630383364383865343838313838222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a2230786438393363613737623331323263623663343830646137663861313263623832653139353432303736663538393566323134343
		6323538646334373361376332222c22746f223a22307838343433316432626533623632383232663063373462666434313062666266316365363634623266222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307839663032636434386231336536386261326131623761303230666237326230666638336534353162222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307861323239396435393432613731356265666539616237336161343061346534313531336135343430222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306
		461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307861643064633962356266343330386363323663316434346531626562326433306334336263613162222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307861643830643431303736373831653932653034396233666136646236366536393238383466663266222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307830373231656563616230383030663234613131663866333439663834636462376538646262636331222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636
		b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307862396131396161303061373262663965663364613338663139613165353530393435643831613431222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307863623239333335356534306234303336666130356663363966613836333032366363313731376437222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307863663231613231373961376362666663646166643537363063643732646635353637636333313130222c22616d74223a2231303030303030303030227d2c7b22702
		23a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307864336536303764353665663261623364633864636237316132326438636635393339666132343139222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307864373561393436323464356264363431663061633036323166366637363663383161646535363633222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a223078313531343339633836363435306230626166646636343937383033316336333065343
		26135313238222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307864613937376137393563383432363633323839623137316133653339623334326563616165633335222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307864643964623037656362323062396566356666666461333335383863396163396434386137636137222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a2230786466376
		2363963323262393666326337653037363837393731353531303231303538323630343531222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307866346161363761353435316337643864323366346538653936623861636466366139343861323663222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307866356439653232653862303536626530643639633036333238373362386439356630326130373830222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a223078643839336361373762333132326362366334383064613766386131326362383265313935343230373666353839356
		63231343436323538646334373361376332222c22746f223a22307866373331353037663064356331353039303564323030343933316135363730336564376466653065222c22616d74223a2231303030303030303030227d2c7b2270223a22626e622d3438222c226f70223a227472616e73666572222c227469636b2d68617368223a22307864383933636137376233313232636236633438306461376638613132636238326531393534323037366635383935663231343436323538646334373361376332222c22746f223a22307866613833343333646231636630376238623866346661393561666533373365323838383838383838222c22616d74223a2231303030303030303030227d5d",
		                "type": 2,
		                "create_at": 1705161397,
		                "update_at": 1705161397,
		                "delete_at": 0
		        }
		--- PASS: TestNewStructToJson (0.21s)
		PASS
	*/
}
